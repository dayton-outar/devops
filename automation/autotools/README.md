# Autotools Cheat Sheet

Autotools is a comprehensive guide to the GNU Autotools, a collection of tools used in Unix-based systems for building, configuring, and distributing software projects.

Please take note of the [Jupiter](./jupiter/) Autotools example. Explanations of the configurations are provided for the Jupiter project.

## The Need for Configuration

> Originally, configuration scripts were hand-coded shell scripts designed to set environment variables based on platform-specific characteristics. They also allowed users to configure package options before running `make`. This approach worked well for decades, but as the number of Linux distributions and Unix-like systems grew, the variety of features and installation and configuration options exploded, so it became very difficult to write a decent portable configuration script. In fact, it was much more difficult to write a portable configuration script than it was to write makefiles for a new project. Therefore, most people just created configuration scripts for their projects by copying and modifying the script for a similar project.
>
> ... The number of GNU project packages had grown to hundreds, and maintaining consistency across their separate build systems had become more time-consuming than simply maintaining the code for these projects. These problems had to be solved.
> 
> **Autoconf** changed this paradigm almost overnight.

## **Overview**

> The Autotools provide you with a build environment that allows your project to build successfully on future versions or distributions with virtually no changes to the build scripts.

> About the only time it makes sense not to use the Autotools is when you’re writing software that will only run on non-Unix [POSIX-compliant] platforms, such as Microsoft Windows.

Autotools provides a framework for creating portable and flexible build systems. It typically consists of these key files:
- **configure.ac**: Input file for `autoconf`, specifies checks and options.
- **Makefile.am**: Input file for `automake`, specifies build targets.
- **config.h.in**: Template for configuration header, filled in by `autoheader`.

---

## **Workflow**

1. **Write Source Code**: Create the code that needs to be compiled and installed.
2. **Create Build Scripts**:
   - **Makefile.am**: Describes what needs to be built and installed.
   - **configure.ac**: Describes system checks, feature tests, etc.
3. **Generate Build System**:
   - **`mkdir m4`**: Make _m4_ directory before performing `autoreconf` and set `AC_CONFIG_MACRO_DIRS([m4])` right after `AC_INIT`
   - **`autoreconf -i`**: Automatically runs `aclocal`, `autoheader`, `automake`, and `autoconf`.
4. **Run Configuration**:
   - **`./configure`**: Script generated by Autoconf to check system and configure the package.
5. **Build the Project**:
   - **`make`**: Builds the project.
6. **Install the Project**:
   - **`make install`**: Installs the project to the appropriate system directories.

---

## **Autoconf (configure.ac)**

The input file for autoconf is called _configure.ac_. The simplest possible _configure.ac_ file has just two lines,

```bash
AC_INIT([Jupiter], [1.0])
AC_OUTPUT
```

Autoconf generates the **`configure`** script, which tests system features and sets up compilation parameters.

### **Syntax for `configure.ac`**:
```bash
AC_INIT([package-name], [version], [bug-report-email])
AM_INIT_AUTOMAKE

# Checks for programs
AC_PROG_CC          # Check for C compiler
AC_PROG_CXX         # Check for C++ compiler

# Checks for libraries
AC_CHECK_LIB([m], [cos])  # Checks for the math library

# Checks for headers
AC_CHECK_HEADERS([stdio.h math.h])

# Output files
AC_CONFIG_FILES([Makefile])
AC_OUTPUT
```

In the Autotools function `AC_CHECK_LIB([m], [cos])`, the second argument `[cos]` represents a function that exists within the library being checked, in this case, the `libm` math library.

- **First argument** (`[m]`): Refers to the library, which is `libm` (the math library on many Unix-like systems).
- **Second argument** (`[cos]`): Refers to a function that should be available in the `libm` library (in this case, the cosine function `cos()`).

This macro checks whether the math library (`libm`) provides the `cos()` function. If this function is found in the library, it sets a flag indicating that the library can be used, otherwise, it reports that the library or function is missing.

### **Common Macros**
- **`AC_INIT`**: Initialize the package information.
- **`AM_INIT_AUTOMAKE`**: Initialize Automake options.
- **`AC_PROG_CC`**: Check for a C compiler.
- **`AC_PROG_CXX`**: Check for a C++ compiler.
- **`AC_CHECK_LIB`**: Check for a library (e.g., `-lm`).
- **`AC_CHECK_HEADERS`**: Check for system headers.
- **`AC_CONFIG_FILES`**: Specify files to be generated by `configure`.
- **`AC_OUTPUT`**: Generates the output files, typically `Makefile` and `config.h`.

---

## **Automake (Makefile.am)**

Automake generates **Makefile.in** from **Makefile.am**, which is processed by Autoconf to create a final **Makefile**.

### **Simple Example for `Makefile.am`**:
```makefile
bin_PROGRAMS = myapp            # Programs to be built
myapp_SOURCES = main.c util.c   # Source files for the program

# Data to install
pkgdata_DATA = README.md        # Files to be installed as data

# Header files to install
include_HEADERS = myheader.h    # Header files to install

# Custom commands for cleaning up
EXTRA_DIST = README.md INSTALL  # Extra files to distribute
```

### **Key Variables**
- **bin_PROGRAMS**: Executables to be built and installed in `$(bindir)`.
- **lib_LIBRARIES**: Libraries to be built.
- **myapp_SOURCES**: List of source files for a particular target (e.g., `myapp`).
- **include_HEADERS**: Header files to be installed.
- **pkgdata_DATA**: Data files to be installed.
- **EXTRA_DIST**: Extra files to be included in the distribution archive.
  
---

## **Automake Directives**
- **`AUTOMAKE_OPTIONS`**: Used in `Makefile.am` to specify options for Automake (e.g., `foreign` to allow non-GNU standards).
- **`SUBDIRS`**: Used to specify directories for recursive builds.
  
---

## **Common Automake Commands**
- **`automake --add-missing`**: Add missing files to the project (e.g., `INSTALL` or `COPYING`).
- **`automake`**: Generates `Makefile.in` from `Makefile.am`.

---

## **Libtool**

How do you build shared libraries on different Unix platforms without adding a lot of very platform-specific conditional code to your build system and source code? This is the question that the Libtool project tries to address.

Libtool helps manage shared libraries across platforms.

### **Libtool in `configure.ac`**:
```bash
AC_PROG_LIBTOOL
```

The `AC_PROG_LIBTOOL` macro in Autotools is used to detect and initialize **Libtool**, a tool that helps manage the creation of shared libraries across different platforms. Libtool abstracts the platform-specific details of building shared and static libraries, allowing developers to write portable build scripts.

Here’s what it does:

1. **Initializes Libtool**: It sets up the build environment to use `libtool`, preparing the project to handle shared and static libraries.
  
2. **Checks for `libtoolize`**: It checks if `libtool` is installed on the system and if the necessary `libtoolize` script is available.

3. **Sets appropriate flags**: It adds necessary flags (`LDFLAGS`, `LIBS`, etc.) to handle linking with libraries in a platform-independent manner.

After `AC_PROG_LIBTOOL` is invoked, the build system will use `libtool` to compile and link the libraries in a way that is compatible with the host platform, making it easier to manage shared libraries across different systems.

### **Libtool in `Makefile.am`**:
```makefile
lib_LTLIBRARIES = libmylib.la   # A libtool library
libmylib_la_SOURCES = mylib.c   # Source files for the library
```

### **Common Commands**
- **`lib_LTLIBRARIES`**: List of libraries to be built.
- **`libmylib_la_SOURCES`**: Source files for the library `libmylib.la`.

---

## **Autoheader**

Autoheader creates a template header file (`config.h.in`) based on the checks defined in **`configure.ac`**.

### Example:
- In `configure.ac`:
  ```bash
  AC_CONFIG_HEADERS([config.h])
  ```

- Then, run:
  ```bash
  autoheader
  ```
  
  This creates `config.h.in`, a template file that defines macros for the detected system features.

---

## **Other Useful Commands**

- **`aclocal`**: Generates the `aclocal.m4` file with macros for Autoconf.
- **`autoconf`**: Creates the `configure` script from `configure.ac`.
- **`autoheader`**: Creates a template header file (`config.h.in`) from `configure.ac`.
- **`autoreconf -i`**: Automatically runs the full sequence of tools (`autoconf`, `automake`, etc.).
- **`automake`**: Generates `Makefile.in` from `Makefile.am`.

---

## **Building and Installation Commands**

- **`./configure`**: Runs the generated `configure` script to set up the project for the local system.
- **`make`**: Builds the project using the generated `Makefile`.
- **`make install`**: Installs the built program to system directories.
- **`make clean`**: Cleans up intermediate files created by the build.
- **`make dist`**: Creates a distribution tarball for the project.

---

## Release Documents

Autotools, by default, expects documentation files such as `README`, `AUTHORS`, `INSTALL`, `NEWS`, and `COPYING` to be present in plain text format without extensions like `.md`. However, you can configure your `Makefile.am` to recognize files with `.md` extensions (Markdown format) by renaming them and making sure they are included properly during the packaging process.

Here’s how you can configure it:

1. **Rename the files**:
   - Rename your Markdown files as `README.md`, `AUTHORS.md`, `INSTALL.md`, `NEWS.md`, and `COPYING.md`.

2. **Update `Makefile.am`**:
   In your `Makefile.am`, you can specify the locations of these Markdown files by assigning them to the appropriate variables that Autotools uses for distribution. This tells Autotools to include these files when packaging your project.

   For example:
   ```makefile
   # Tell Autotools to look for Markdown versions of these files
   EXTRA_DIST = README.md AUTHORS.md INSTALL.md NEWS.md COPYING.md

   # Install these files as the standard ones expected by Autotools
   dist_doc_DATA = README.md AUTHORS.md INSTALL.md NEWS.md COPYING.md
   ```

3. **Ensure the package includes these files**:
   When you run the `make dist` command, it will package the `.md` versions of these files and include them in your distribution.

4. **Optionally generate the plain-text versions**:
   If you still need plain-text versions for compatibility, you could use a conversion tool (such as `pandoc`) in your build scripts to generate `.txt` versions of the Markdown files. For example, you could add a script or target to your `Makefile.am` to convert `README.md` to `README`:
   ```makefile
   README: README.md
       pandoc README.md -o README
   ```

This way, Autotools will recognize and distribute the `.md` files while maintaining the expected behavior.

---

This cheat sheet covers the fundamental concepts and commands in **Autotools**. With `configure.ac` and `Makefile.am`, Autotools generates portable build systems suitable for many Unix-like environments.

## Further Reading

1. Autotools, 2<sup>nd</sup> Edition - John Calcote
2. [GNU Automake](https://www.gnu.org/software/automake/manual/html_node/index.html)

## Videos

1. [How to use autotools (automake, autoconf, aclocal, autoheader)](https://youtu.be/3XO0d9Qyc34?si=sLgmEegcxB_NZg30)